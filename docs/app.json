[{"name":"app.R","content":"library(shiny)\r\n\r\n# WICHTIG: Upload-Limit auf 30 MB erhöhen\r\noptions(shiny.maxRequestSize = 30 * 1024^2)\r\n\r\n# --- UI ---\r\nui <- fluidPage(\r\n  titlePanel(\"ER Model Viewer (Browser Edition)\"),\r\n  \r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      # Upload\r\n      fileInput(\"file1\", \"Upload CSV Data Dictionary\", accept = c(\".csv\", \"text/csv\")),\r\n      \r\n      # Trennzeichen: Jetzt mit Pipe (|) als Standard\r\n      radioButtons(\"sep\", \"CSV Trennzeichen:\",\r\n                   choices = c(\"Pipe (|)\" = \"|\", \r\n                               \"Semikolon (;)\" = \";\", \r\n                               \"Komma (,)\" = \",\"),\r\n                   selected = \"|\", inline = TRUE),\r\n      \r\n      hr(),\r\n      \r\n      h4(\"Suche & Filter\"),\r\n      selectizeInput(\"table_search\", \"Tabelle suchen:\", choices = NULL, multiple = TRUE, \r\n                     options = list(placeholder = 'Tippen zum Suchen...')),\r\n      \r\n      helpText(\"ODER Slider nutzen:\"),\r\n      sliderInput(\"table_limit\", \"Zeige Top N Tabellen:\", min = 1, max = 50, value = 5),\r\n      \r\n      hr(),\r\n      checkboxInput(\"auto_connect\", \"Beziehungen anzeigen?\", value = TRUE),\r\n      checkboxInput(\"show_ghosts\", \"Externe Referenzen (Ghosts)?\", value = TRUE),\r\n      \r\n      hr(),\r\n      selectInput(\"rank_dir\", \"Ausrichtung:\", choices = c(\"Links-nach-Rechts\" = \"LR\", \"Oben-nach-Unten\" = \"TB\")),\r\n      selectInput(\"line_style\", \"Linienstil:\", choices = c(\"Orthogonal\" = \"ortho\", \"Kurvig\" = \"spline\", \"Polyline\" = \"polyline\"))\r\n    ),\r\n    \r\n    mainPanel(\r\n      tabsetPanel(\r\n        tabPanel(\"ER Diagramm\", \r\n                 DiagrammeR::grVizOutput(\"er_plot\", height = \"800px\")\r\n        ),\r\n        tabPanel(\"Daten Prüfung\", \r\n                 h4(\"Geparste CSV Daten\"),\r\n                 tableOutput(\"debug_table\")\r\n        )\r\n      )\r\n    )\r\n  )\r\n)\r\n\r\n# --- SERVER ---\r\nserver <- function(input, output, session) {\r\n  \r\n  # 1. READ & INDEX\r\n  full_data <- reactive({\r\n    req(input$file1)\r\n    \r\n    # readr::read_delim mit dynamischem Trenner\r\n    raw_df <- readr::read_delim(\r\n      input$file1$datapath, \r\n      delim = input$sep, \r\n      col_types = readr::cols(.default = \"c\"), \r\n      show_col_types = FALSE\r\n    )\r\n    \r\n    # Pre-process\r\n    df_indexed <- raw_df |>\r\n      dplyr::mutate(global_row_id = dplyr::row_number()) |>\r\n      janitor::clean_names() |>\r\n      dplyr::rename(\r\n        table_name = ida_view,\r\n        col_name   = ida_attribut,\r\n        pk_flag    = primarschlussel,\r\n        data_type  = datentyp\r\n      ) |>\r\n      dplyr::filter(!is.na(table_name)) |>\r\n      dplyr::mutate(table_name = trimws(table_name))\r\n    \r\n    # Sortier-Logik\r\n    table_order <- df_indexed |>\r\n      dplyr::group_by(table_name) |>\r\n      dplyr::summarise(first_appearance = min(global_row_id)) |>\r\n      dplyr::arrange(first_appearance)\r\n    \r\n    # Join & Clean\r\n    df_clean <- df_indexed |>\r\n      dplyr::left_join(table_order, by = \"table_name\") |>\r\n      dplyr::group_by(table_name) |>\r\n      dplyr::mutate(col_order = dplyr::row_number()) |>\r\n      dplyr::ungroup() |>\r\n      dplyr::mutate(\r\n        table_id = paste0(\"t_\", gsub(\"[^a-zA-Z0-9]\", \"_\", table_name)),\r\n        table_label_safe = htmltools::htmlEscape(table_name),\r\n        col_label_safe   = htmltools::htmlEscape(col_name),\r\n        type_label_safe  = htmltools::htmlEscape(data_type),\r\n        is_pk = grepl(\"(?i)(yes|x|true|1|j|y|ja)\", as.character(pk_flag))\r\n      )\r\n    \r\n    # FK Detection\r\n    all_pks <- df_clean |> \r\n      dplyr::filter(is_pk) |> \r\n      dplyr::select(pk_col = col_name, target_table = table_id) |> \r\n      dplyr::distinct() |>\r\n      dplyr::filter(!tolower(pk_col) %in% c(\"id\", \"status\", \"source\", \"mandant\"))\r\n    \r\n    df_enriched <- df_clean |>\r\n      dplyr::left_join(all_pks, by = c(\"col_name\" = \"pk_col\"), relationship = \"many-to-many\") |>\r\n      dplyr::mutate(is_fk = !is.na(target_table) & (table_id != target_table)) |>\r\n      dplyr::group_by(table_id, col_name) |>\r\n      dplyr::slice(1) |>\r\n      dplyr::ungroup() |>\r\n      dplyr::arrange(first_appearance, col_order)\r\n    \r\n    df_enriched\r\n  })\r\n  \r\n  # 2. UPDATE SEARCH BOX\r\n  observe({\r\n    req(full_data())\r\n    tables <- unique(full_data()$table_name)\r\n    updateSelectizeInput(session, \"table_search\", choices = tables, server = TRUE)\r\n  })\r\n  \r\n  # 3. FILTER LOGIC\r\n  filtered_data <- reactive({\r\n    req(full_data())\r\n    df <- full_data()\r\n    ordered_ids <- unique(df$table_id)\r\n    \r\n    target_ids <- if (!is.null(input$table_search) && length(input$table_search) > 0) {\r\n      df |> \r\n        dplyr::filter(table_name %in% input$table_search) |> \r\n        dplyr::pull(table_id) |> \r\n        unique()\r\n    } else {\r\n      head(ordered_ids, input$table_limit)\r\n    }\r\n    \r\n    df |> \r\n      dplyr::filter(table_id %in% target_ids) |>\r\n      dplyr::arrange(first_appearance, col_order)\r\n  })\r\n  \r\n  # 4. GRAPH CODE\r\n  graph_code <- reactive({\r\n    req(filtered_data())\r\n    df_render <- filtered_data()\r\n    \r\n    # Nodes\r\n    df_nodes <- df_render |>\r\n      dplyr::mutate(base_port_id = gsub(\"[^a-zA-Z0-9]\", \"_\", col_name)) |>\r\n      dplyr::arrange(dplyr::desc(is_pk), col_order) |>\r\n      dplyr::mutate(\r\n        flag_text = dplyr::case_when(is_pk & is_fk ~ \"PK,FK\", is_pk ~ \"PK\", is_fk ~ \"FK\", TRUE ~ \"\"),\r\n        flag_html = ifelse(flag_text != \"\", paste0(\"<b>\", flag_text, \"<\/b>\"), \"\"),\r\n        label_html = glue::glue(\r\n          \"<tr><td align='right' width='30' port='{base_port_id}_L'>{flag_html}<\/td><td align='left'> {col_label_safe} <\/td><td align='right' port='{base_port_id}_R'><i>{type_label_safe}<\/i><\/td><\/tr>\"\r\n        )\r\n      ) |>\r\n      dplyr::group_by(table_id, table_label_safe) |>\r\n      dplyr::summarise(cols_string = paste(label_html, collapse = \"\"), .groups = \"drop\") |>\r\n      dplyr::mutate(node_def = glue::glue('{table_id} [label=<<table border=\"0\" cellborder=\"1\" cellspacing=\"0\"><tr><td colspan=\"3\" bgcolor=\"#E0E0E0\"><b>{table_label_safe}<\/b><\/td><\/tr>{cols_string}<\/table>> shape=plain]'))\r\n    \r\n    main_nodes_def <- paste(df_nodes$node_def, collapse = \"\\n\")\r\n    \r\n    # Edges & Ghosts\r\n    ghost_nodes_def <- \"\"\r\n    all_edges <- \"\"\r\n    \r\n    if (input$auto_connect) {\r\n      relationships <- df_render |>\r\n        dplyr::filter(is_fk) |>\r\n        dplyr::mutate(col_port_id = gsub(\"[^a-zA-Z0-9]\", \"_\", col_name)) |>\r\n        dplyr::select(source_table = table_id, target_table, col_port_id) |>\r\n        dplyr::distinct()\r\n      \r\n      visible_ids <- unique(df_render$table_id)\r\n      ghost_ids   <- setdiff(relationships$target_table, visible_ids)\r\n      \r\n      if (input$show_ghosts && length(ghost_ids) > 0) {\r\n        ghost_defs <- data.frame(id = ghost_ids) |>\r\n          dplyr::mutate(label = sub(\"^t_\", \"\", id), def = glue::glue('{id} [label=\"{label}\", shape=box, style=dashed, fontcolor=\"#777777\", color=\"#777777\", fontsize=10]'))\r\n        ghost_nodes_def <- paste(ghost_defs$def, collapse = \"\\n\")\r\n      }\r\n      \r\n      if (nrow(relationships) > 0) {\r\n        relationships <- relationships |>\r\n          dplyr::mutate(\r\n            is_ghost = target_table %in% ghost_ids,\r\n            should_draw = !is_ghost | (is_ghost & input$show_ghosts),\r\n            edge_def = dplyr::if_else(is_ghost,\r\n                                      glue::glue(\"{source_table}:{col_port_id}_R:e -> {target_table} [arrowtail=crow, arrowhead=none, dir=both, style=dashed, color=\\\"#999999\\\"]\"),\r\n                                      glue::glue(\"{source_table}:{col_port_id}_R:e -> {target_table}:{col_port_id}_L:w [arrowtail=crow, arrowhead=tee, dir=both, color=\\\"#555555\\\"]\")\r\n            )\r\n          ) |>\r\n          dplyr::filter(should_draw)\r\n        all_edges <- paste(relationships$edge_def, collapse = \"\\n\")\r\n      }\r\n    }\r\n    \r\n    glue::glue(\"digraph ER {{ graph [rankdir={input$rank_dir}, splines={input$line_style}, nodesep=0.8, ranksep=1.0] node [fontname = \\\"Helvetica\\\", fontsize=10] edge [arrowhead=none, arrowtail=crow] \\n {main_nodes_def} \\n {ghost_nodes_def} \\n {all_edges} }}\")\r\n  })\r\n  \r\n  # 5. OUTPUTS\r\n  output$er_plot <- DiagrammeR::renderGrViz({ DiagrammeR::grViz(graph_code()) })\r\n  \r\n  output$debug_table <- renderTable({\r\n    filtered_data() |> \r\n      dplyr::select(Table = table_name, Column = col_name, Type = data_type, PK = is_pk, FK = is_fk, Target = target_table) |>\r\n      head(50)\r\n  })\r\n}\r\n\r\nshinyApp(ui, server)","type":"text"}]
